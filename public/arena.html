<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>  AntiChat </title>
<style>
  body {
    margin: 0; padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #e5ddd5;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #chatContainer {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #ece5dd;
  }
  .message {
    max-width: 70%;
    margin: 6px 0;
    padding: 10px;
    border-radius: 7.5px;
    clear: both;
    word-wrap: break-word;
  }
  .message.you {
    background-color: #dcf8c6;
    float: right;
    text-align: right;
  }
  .message.other {
    background-color: white;
    float: left;
    text-align: left;
  }
  .message strong {
    display: block;
    margin-bottom: 4px;
    font-weight: 600;
  }
  .message small {
    color: gray;
    font-size: 10px;
  }
  img, video, audio {
    border-radius: 5px;
    margin-top: 5px;
    max-width: 100%;
  }
  #inputArea {
    display: flex;
    padding: 10px;
    background: #f0f0f0;
    border-top: 1px solid #ddd;
  }
  #messageInput {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
  }
  #fileInput {
    margin-left: 10px;
  }
  #sendBtn {
    margin-left: 10px;
    padding: 0 16px;
    border: none;
    background-color: #128c7e;
    color: white;
    border-radius: 20px;
    cursor: pointer;
  }
  #sendBtn:disabled {
    background-color: #bbb;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<div id="chatContainer"></div>

<div id="inputArea">
  <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" />
  <input type="file" id="fileInput" />
  <button id="sendBtn">Send</button>
</div>

<script>
  // Client-side JS inside arena.html

  const username = localStorage.getItem('username') || prompt('Enter your username (no spaces or #):');
  if (!username || username.includes(' ') || username.includes('#')) {
    alert('Invalid username, reload and enter a valid one.');
    throw new Error('Invalid username');
  }
  localStorage.setItem('username', username);

  const chatContainer = document.getElementById('chatContainer');
  const messageInput = document.getElementById('messageInput');
  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  async function sendMessage() {
    if (sendBtn.disabled) return;
    sendBtn.disabled = true;

    const file = fileInput.files[0];

    if (file) {
      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/api/upload', { method: 'POST', body: formData });
        const data = await res.json();
        if (!data.url) throw new Error('Upload failed');

        let type = 'file';
        if (file.type.startsWith('image/')) type = 'image';
        else if (file.type.startsWith('video/')) type = 'video';
        else if (file.type.startsWith('audio/')) type = 'audio';

        await postMessage('', type, data.url);
        fileInput.value = '';
      } catch (err) {
        alert('File upload error: ' + err.message);
      }
    } else {
      const text = messageInput.value.trim();
      if (!text) {
        sendBtn.disabled = false;
        return;
      }
      await postMessage(text, 'text', null);
      messageInput.value = '';
    }

    await fetchMessages();
    sendBtn.disabled = false;
  }

  async function postMessage(content, type, fileUrl) {
    await fetch('/api/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, content, type, fileUrl }),
    });
  }

  async function fetchMessages() {
    const res = await fetch('/api/messages');
    const messages = await res.json();
    chatContainer.innerHTML = '';

    messages.forEach((msg) => {
      const div = document.createElement('div');
      div.classList.add('message');
      div.classList.add(msg.username === username ? 'you' : 'other');

      let contentHtml = '';

      if (msg.type === 'text') {
        contentHtml = `<p>${escapeHtml(msg.content)}</p>`;
      } else if (msg.type === 'image') {
        contentHtml = `<img src="${msg.fileUrl}" alt="Image" />`;
      } else if (msg.type === 'video') {
        contentHtml = `<video controls><source src="${msg.fileUrl}" type="video/mp4" />Your browser does not support the video tag.</video>`;
      } else if (msg.type === 'audio') {
        contentHtml = `<audio controls><source src="${msg.fileUrl}" type="audio/mpeg" />Your browser does not support the audio element.</audio>`;
      } else if (msg.type === 'file') {
        const fileName = msg.fileUrl.split('/').pop();
        contentHtml = `<a href="${msg.fileUrl}" target="_blank" download>${fileName}</a>`;
      }

      div.innerHTML = `<strong>${escapeHtml(msg.username)}</strong>${contentHtml}<br><small>${new Date(msg.timestamp).toLocaleTimeString()}</small>`;

      chatContainer.appendChild(div);
    });

    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, (m) => {
      return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
    });
  }

  setInterval(fetchMessages, 3000);
  fetchMessages();
</script>

</body>
</html>
