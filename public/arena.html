<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AntiChat - Arena</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" />
<style>
  body {
    margin: 0; font-family: 'Roboto Mono', monospace;
    background: #121212; color: #e0e0e0;
    display: flex; flex-direction: column; height: 100vh;
  }
  header {
    background: #1a1a1a; padding: 10px 20px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid #333;
  }
  header h1 {
    margin: 0; font-weight: 700; color: #00bcd4;
  }
  #chat {
    flex: 1; overflow-y: auto; padding: 15px;
    background: #222; display: flex; flex-direction: column;
  }
  .message {
    max-width: 60%; margin-bottom: 10px;
    padding: 8px 12px; border-radius: 10px;
    position: relative;
    word-wrap: break-word;
  }
  .message.own {
    background: #00bcd4;
    color: #000;
    align-self: flex-end;
    border-bottom-right-radius: 0;
  }
  .message.other {
    background: #333;
    color: #eee;
    align-self: flex-start;
    border-bottom-left-radius: 0;
  }
  .msg-header {
    font-weight: 700; font-size: 0.9em; margin-bottom: 4px;
  }
  .msg-time {
    font-size: 0.75em; color: #bbb;
    position: absolute; bottom: 4px; right: 8px;
  }
  .msg-text {
    white-space: pre-wrap;
  }
  .msg-actions {
    position: absolute; top: 4px; right: 8px;
    display: none;
    gap: 6px;
  }
  .message:hover .msg-actions {
    display: flex;
  }
  button.action-btn {
    background: transparent; border: none; cursor: pointer;
    color: inherit; font-size: 0.8em;
    padding: 2px 6px;
    border-radius: 4px;
  }
  button.action-btn:hover {
    background: rgba(255 255 255 / 0.2);
  }
  #input-area {
    padding: 10px 20px; background: #1a1a1a;
    display: flex; gap: 10px;
    align-items: center;
  }
  #message-input {
    flex: 1; padding: 8px 12px;
    border-radius: 6px; border: none;
    font-size: 1em; font-family: inherit;
  }
  #file-input {
    display: none;
  }
  label[for="file-input"] {
    background: #00bcd4; color: #000;
    padding: 8px 12px; border-radius: 6px;
    cursor: pointer; font-weight: 700;
  }
  #send-btn {
    background: #00bcd4; border: none;
    color: #000; padding: 8px 16px;
    font-weight: 700; border-radius: 6px;
    cursor: pointer;
  }
  #send-btn:disabled {
    background: #007c91;
    cursor: not-allowed;
  }
  .file-link {
    display: inline-block;
    margin-top: 5px;
    color: #00bcd4;
    text-decoration: underline;
    cursor: pointer;
  }
  #edit-area {
    display: none;
    padding: 10px 20px; background: #222;
    border-top: 1px solid #333;
  }
  #edit-input {
    width: 100%;
    padding: 8px 12px;
    font-family: inherit;
    font-size: 1em;
    border-radius: 6px;
    border: none;
  }
  #edit-buttons {
    margin-top: 8px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  #edit-save, #edit-cancel {
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    font-weight: 700;
    cursor: pointer;
  }
  #edit-save {
    background: #00bcd4;
    color: #000;
  }
  #edit-cancel {
    background: #555;
    color: #eee;
  }
</style>
</head>
<body>

<header>
  <h1>AntiChat Arena</h1>
  <button id="logout-btn" title="Logout">Logout</button>
</header>

<div id="chat"></div>

<div id="input-area">
  <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" />
  <label for="file-input" title="Upload a file">📎</label>
  <input type="file" id="file-input" />
  <button id="send-btn" disabled>Send</button>
</div>

<div id="edit-area">
  <input type="text" id="edit-input" />
  <div id="edit-buttons">
    <button id="edit-save">Save</button>
    <button id="edit-cancel">Cancel</button>
  </div>
</div>

<script>
  const chatDiv = document.getElementById('chat');
  const messageInput = document.getElementById('message-input');
  const fileInput = document.getElementById('file-input');
  const sendBtn = document.getElementById('send-btn');
  const logoutBtn = document.getElementById('logout-btn');

  const editArea = document.getElementById('edit-area');
  const editInput = document.getElementById('edit-input');
  const editSaveBtn = document.getElementById('edit-save');
  const editCancelBtn = document.getElementById('edit-cancel');

  let editingMessageId = null;
  let uploadedFile = null;

  const username = localStorage.getItem('antichat_username');
  const name = localStorage.getItem('antichat_name');

  if (!username || !name) {
    alert('You are not logged in. Redirecting to login page.');
    window.location.href = '/chat.html';
  }

  function formatTime(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function createMessageElem(msg) {
    const div = document.createElement('div');
    div.classList.add('message');
    div.classList.add(msg.username === username ? 'own' : 'other');
    div.dataset.id = msg.id;

    // Header with username
    const header = document.createElement('div');
    header.className = 'msg-header';
    header.textContent = msg.name || msg.username;
    div.appendChild(header);

    // Message text
    const textDiv = document.createElement('div');
    textDiv.className = 'msg-text';
    textDiv.textContent = msg.text || '';
    div.appendChild(textDiv);

    // File link (if any)
    if (msg.fileUrl) {
      const fileLink = document.createElement('a');
      fileLink.href = msg.fileUrl;
      fileLink.target = '_blank';
      fileLink.className = 'file-link';
      fileLink.textContent = msg.fileName || 'Attachment';
      div.appendChild(fileLink);
    }

    // Timestamp
    const timeSpan = document.createElement('span');
    timeSpan.className = 'msg-time';
    timeSpan.textContent = formatTime(msg.createdAt || new Date());
    div.appendChild(timeSpan);

    // Actions (Edit/Delete) only on own messages
    if (msg.username === username) {
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'msg-actions';

      // Edit button
      const editBtn = document.createElement('button');
      editBtn.className = 'action-btn';
      editBtn.title = 'Edit message';
      editBtn.textContent = '✏️';
      editBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        startEditingMessage(msg);
      });
      actionsDiv.appendChild(editBtn);

      // Delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'action-btn';
      deleteBtn.title = 'Delete message';
      deleteBtn.textContent = '🗑️';
      deleteBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (confirm('Delete this message?')) {
          await deleteMessage(msg.id);
          await loadMessages();
        }
      });
      actionsDiv.appendChild(deleteBtn);

      div.appendChild(actionsDiv);
    }

    return div;
  }

  async function loadMessages() {
    try {
      const res = await fetch('/api/messages');
      const messages = await res.json();

      chatDiv.innerHTML = '';
      messages.forEach(msg => {
        const msgElem = createMessageElem(msg);
        chatDiv.appendChild(msgElem);
      });

      chatDiv.scrollTop = chatDiv.scrollHeight;
    } catch (err) {
      console.error('Failed to load messages:', err);
    }
  }

  async function sendMessage(text, fileUrl = null, fileName = null) {
    if (!text && !fileUrl) return;
    try {
      sendBtn.disabled = true;
      await fetch('/api/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, name, text, fileUrl, fileName })
      });
      messageInput.value = '';
      uploadedFile = null;
      fileInput.value = '';
      sendBtn.disabled = true;
      await loadMessages();
    } catch (err) {
      console.error('Failed to send message:', err);
    }
  }

  async function deleteMessage(id) {
    try {
      await fetch(`/api/messages?id=${encodeURIComponent(id)}`, {
        method: 'DELETE',
      });
    } catch (err) {
      console.error('Failed to delete message:', err);
    }
  }

  async function updateMessage(id, newText) {
    try {
      await fetch(`/api/messages?id=${encodeURIComponent(id)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: newText }),
      });
    } catch (err) {
      console.error('Failed to update message:', err);
    }
  }

  function startEditingMessage(msg) {
    editingMessageId = msg.id;
    editInput.value = msg.text || '';
    editArea.style.display = 'block';
    messageInput.disabled = true;
    sendBtn.disabled = true;
    fileInput.disabled = true;
    chatDiv.style.filter = 'blur(2px)';
  }

  function cancelEditing() {
    editingMessageId = null;
    editInput.value = '';
    editArea.style.display = 'none';
    messageInput.disabled = false;
    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
    fileInput.disabled = false;
    chatDiv.style.filter = 'none';
  }

  async function saveEdit() {
    const newText = editInput.value.trim();
    if (!newText) {
      alert('Message cannot be empty.');
      return;
    }
    await updateMessage(editingMessageId, newText);
    cancelEditing();
    await loadMessages();
  }

  // File upload to Cloudflare R2 via fetch (using public upload API or a backend)
  async function uploadFile(file) {
    // Simplified example using a backend endpoint /api/upload which handles R2 upload
    // Replace with your actual upload implementation
    const formData = new FormData();
    formData.append('file', file);

    const res = await fetch('/api/upload', {
      method: 'POST',
      body: formData
    });
    if (!res.ok) throw new Error('File upload failed');
    const data = await res.json();
    return data.fileUrl; // Expect backend to return URL of uploaded file
  }

  fileInput.addEventListener('change', async () => {
    if (!fileInput.files.length) {
      uploadedFile = null;
      sendBtn.disabled = messageInput.value.trim() === '';
      return;
    }

    const file = fileInput.files[0];
    sendBtn.disabled = true;

    try {
      const url = await uploadFile(file);
      uploadedFile = { url, name: file.name };
      sendBtn.disabled = false;
    } catch (err) {
      alert('Failed to upload file.');
      uploadedFile = null;
      sendBtn.disabled = messageInput.value.trim() === '';
    }
  });

  messageInput.addEventListener('input', () => {
    sendBtn.disabled = messageInput.value.trim() === '' && !uploadedFile;
  });

  sendBtn.addEventListener('click', async () => {
    await sendMessage(messageInput.value.trim(), uploadedFile?.url, uploadedFile?.name);
  });

  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('antichat_username');
    localStorage.removeItem('antichat_name');
    window.location.href = '/chat.html';
  });

  // Initial load
  loadMessages();

  // Polling every 3 seconds for new messages
  setInterval(loadMessages, 3000);
</script>

</body>
</html>
