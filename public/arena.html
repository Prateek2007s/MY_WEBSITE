<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AntiChat Arena</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Orbitron&display=swap" />
  <style>
    body {
      font-family: 'Orbitron', monospace;
      background-color: #000;
      color: #00ffcc;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    #chat-header {
      background-color: #111;
      padding: 15px;
      text-align: center;
      font-size: 1.5em;
      border-bottom: 1px solid #00ffcc;
    }
    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      background-color: #111;
    }
    .message {
      margin-bottom: 12px;
      max-width: 80%;
      word-wrap: break-word;
      padding: 8px 12px;
      border-radius: 12px;
      line-height: 1.3;
      font-size: 0.95em;
      position: relative;
    }
    .message .username {
      font-weight: bold;
      margin-bottom: 4px;
      display: block;
      color: #0ff;
    }
    .message.sent {
      background-color: #00ffcc;
      color: #000;
      margin-left: auto;
      border-bottom-right-radius: 0;
    }
    .message.received {
      background-color: #003333;
      color: #00ffcc;
      margin-right: auto;
      border-bottom-left-radius: 0;
    }
    #chat-form {
      display: flex;
      padding: 10px;
      background-color: #111;
      border-top: 1px solid #00ffcc;
    }
    #chat-input {
      flex-grow: 1;
      border: none;
      padding: 10px;
      border-radius: 20px;
      font-size: 1em;
      background: #222;
      color: #00ffcc;
      outline: none;
    }
    #chat-submit {
      background: #00ffcc;
      border: none;
      padding: 10px 20px;
      margin-left: 10px;
      border-radius: 20px;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    #chat-submit:hover {
      background: #00ccaa;
    }

    /* Edit button */
    .edit-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: transparent;
      border: none;
      color: #004040;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.8em;
      padding: 2px 6px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .edit-btn:hover {
      background: #007070;
      color: #00ffcc;
    }

    /* Edit input */
    .edit-input {
      width: 100%;
      padding: 6px 10px;
      font-size: 0.95em;
      border-radius: 8px;
      border: none;
      outline: none;
      background: #222;
      color: #0ff;
    }

    /* Edit action buttons */
    .edit-actions {
      margin-top: 4px;
      text-align: right;
    }
    .edit-actions button {
      background: #00ffcc;
      border: none;
      color: #000;
      font-weight: bold;
      padding: 4px 10px;
      margin-left: 6px;
      border-radius: 8px;
      cursor: pointer;
    }
    .edit-actions button:hover {
      background: #00ccaa;
    }
  </style>
</head>
<body>

  <div id="chat-header">AntiChat Arena</div>

  <div id="chat-container"></div>

  <form id="chat-form">
    <input id="chat-input" placeholder="Type a message..." autocomplete="off" required />
    <button id="chat-submit" type="submit">Send</button>
  </form>

  <script>
    const API = '/api/messages'; // adjust if needed

    const USERNAME = localStorage.getItem('antichat_username');
    const NAME = localStorage.getItem('antichat_name');

    if (!USERNAME || !NAME) {
      alert('You must be logged in!');
      window.location.href = '/chat.html';
    }

    const chatContainer = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Track which message is being edited
    let editingMessageId = null;

    // Render messages
    function renderMessages(messages) {
      chatContainer.innerHTML = '';
      messages.forEach(msg => {
        if (!msg.text) return;

        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');
        msgDiv.dataset.id = msg.id;

        const isOwn = msg.username === USERNAME;
        msgDiv.classList.add(isOwn ? 'sent' : 'received');

        if (editingMessageId === msg.id) {
          // Editing mode
          msgDiv.innerHTML = `
            <span class="username">${escapeHtml(NAME)}</span>
            <textarea class="edit-input" rows="2">${escapeHtml(msg.text)}</textarea>
            <div class="edit-actions">
              <button class="save-btn">Save</button>
              <button class="cancel-btn">Cancel</button>
            </div>
          `;

          // Save button
          msgDiv.querySelector('.save-btn').onclick = async () => {
            const newText = msgDiv.querySelector('.edit-input').value.trim();
            if (!newText) return alert('Message cannot be empty');

            try {
              const res = await fetch(API, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: msg.id, text: newText }),
              });
              if (!res.ok) throw new Error('Failed to update message');
              editingMessageId = null;
              loadMessages();
            } catch (err) {
              alert('Error updating message');
              console.error(err);
            }
          };

          // Cancel button
          msgDiv.querySelector('.cancel-btn').onclick = () => {
            editingMessageId = null;
            loadMessages();
          };

        } else {
          // Normal mode
          msgDiv.innerHTML = `
            <span class="username">${escapeHtml(isOwn ? NAME : msg.username)}</span>
            <span class="text">${escapeHtml(msg.text)}</span>
          `;

          // Add edit button if own message
          if (isOwn) {
            const btn = document.createElement('button');
            btn.className = 'edit-btn';
            btn.textContent = 'Edit';
            btn.title = 'Edit message';
            btn.onclick = () => {
              editingMessageId = msg.id;
              renderMessages(messages);
            };
            msgDiv.appendChild(btn);
          }
        }

        chatContainer.appendChild(msgDiv);
      });

      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function loadMessages() {
      try {
        const res = await fetch(API);
        if (!res.ok) throw new Error('Failed to fetch messages');
        const messages = await res.json();
        renderMessages(messages);
      } catch (err) {
        console.error(err);
      }
    }

    chatForm.addEventListener('submit', async e => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      try {
        const res = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: USERNAME, text }),
        });
        if (!res.ok) throw new Error('Failed to send message');
        chatInput.value = '';
        loadMessages();
      } catch (err) {
        console.error(err);
      }
    });

    loadMessages();
    setInterval(loadMessages, 3000);
  </script>

</body>
</html>
