<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AntiChat - Arena</title>
  <style>
    body {
      font-family: monospace, 'Orbitron', monospace;
      background: #000;
      color: #00ffcc;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; height: 100vh;
    }
    #chat {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      border-bottom: 1px solid #00ffcc;
    }
    #chat div.message {
      margin-bottom: 12px;
      border: 1px solid #00ffcc;
      padding: 5px 10px;
      border-radius: 8px;
      max-width: 70%;
      position: relative;
      word-wrap: break-word;
    }
    #chat div.message.own {
      background: #003333;
      margin-left: auto;
      text-align: right;
    }
    #chat div.message .meta {
      font-size: 0.75em;
      color: #0ff;
      margin-bottom: 4px;
    }
    #chat div.message img {
      max-width: 100%;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 5px;
    }
    #chat div.message button {
      position: absolute;
      top: 4px;
      background: none;
      border: none;
      color: #00ffcc;
      cursor: pointer;
      font-size: 0.75em;
      padding: 0 5px;
    }
    #chat div.message button.delete-btn {
      right: 4px;
    }
    #chat div.message button.edit-btn {
      right: 40px;
    }
    #input-area {
      display: flex;
      padding: 10px;
      background: #111;
      border-top: 1px solid #00ffcc;
    }
    #input-area input[type="text"] {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #00ffcc;
      border-radius: 5px;
      background: #000;
      color: #0ff;
      font-size: 1em;
      outline: none;
    }
    #input-area input[type="file"] {
      margin-left: 10px;
      color: #0ff;
    }
    #input-area button {
      margin-left: 10px;
      background: #00ffcc;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      font-weight: bold;
      cursor: pointer;
      color: #000;
    }
    #input-area button:hover {
      background: #00ccaa;
    }
  </style>
</head>
<body>

  <div id="chat"></div>

  <div id="input-area">
    <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" />
    <input type="file" id="fileInput" />
    <button id="sendBtn">Send</button>
  </div>

  <script>
    // Get logged user info from localStorage
    const username = localStorage.getItem("antichat_username");
    const name = localStorage.getItem("antichat_name");
    if (!username || !name) {
      alert("Not logged in! Redirecting to login.");
      window.location.href = "/chat.html";
    }

    const chat = document.getElementById("chat");
    const messageInput = document.getElementById("messageInput");
    const fileInput = document.getElementById("fileInput");
    const sendBtn = document.getElementById("sendBtn");

    // API endpoint for messages
    const API_MESSAGES = "/api/messages";
    const API_UPLOAD = "/api/upload";

    // Load messages and refresh every 3 seconds
    async function loadMessages() {
      try {
        const res = await fetch(API_MESSAGES);
        const data = await res.json();
        chat.innerHTML = "";

        data.forEach((msg) => {
          const isOwn = msg.username === username;
          const msgDiv = document.createElement("div");
          msgDiv.className = "message" + (isOwn ? " own" : "");
          msgDiv.dataset.id = msg.id;

          // Meta info (name and username)
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `${msg.name} (@${msg.username})`;
          msgDiv.appendChild(meta);

          // Message text or file
          if (msg.fileUrl) {
            const link = document.createElement("a");
            link.href = msg.fileUrl;
            link.target = "_blank";
            link.rel = "noopener noreferrer";

            if (msg.fileUrl.match(/\.(jpeg|jpg|gif|png|svg|webp)$/i)) {
              const img = document.createElement("img");
              img.src = msg.fileUrl;
              img.alt = "Uploaded Image";
              link.appendChild(img);
            } else {
              link.textContent = msg.fileUrl;
            }
            msgDiv.appendChild(link);
          }

          if (msg.text) {
            const textP = document.createElement("p");
            textP.textContent = msg.text;
            msgDiv.appendChild(textP);
          }

          // Add delete and edit buttons if own message
          if (isOwn) {
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-btn";
            deleteBtn.textContent = "Delete";
            deleteBtn.onclick = () => deleteMessage(msg.id);
            msgDiv.appendChild(deleteBtn);

            const editBtn = document.createElement("button");
            editBtn.className = "edit-btn";
            editBtn.textContent = "Edit";
            editBtn.onclick = () => editMessage(msg.id, msg.text);
            msgDiv.appendChild(editBtn);
          }

          chat.appendChild(msgDiv);
        });

        chat.scrollTop = chat.scrollHeight;
      } catch (err) {
        console.error("Load messages error:", err);
      }
    }

    // Send message function
    async function sendMessage() {
      const text = messageInput.value.trim();
      const file = fileInput.files[0];

      if (!text && !file) {
        alert("Type a message or select a file to send.");
        return;
      }

      if (file) {
        // Upload file first
        const formData = new FormData();
        formData.append("file", file);

        try {
          const res = await fetch(API_UPLOAD, {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (data.url) {
            await postMessage("", data.url);
            messageInput.value = "";
            fileInput.value = "";
            loadMessages();
          } else {
            alert("Failed to upload file.");
          }
        } catch (err) {
          alert("Upload failed.");
          console.error(err);
        }
      } else {
        await postMessage(text, "");
        messageInput.value = "";
        loadMessages();
      }
    }

    async function postMessage(text, fileUrl) {
      try {
        await fetch(API_MESSAGES, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, name, text, fileUrl }),
        });
      } catch (err) {
        console.error("Send message error:", err);
      }
    }

    async function deleteMessage(id) {
      if (!confirm("Delete this message?")) return;
      try {
        await fetch(`${API_MESSAGES}?id=${id}`, { method: "DELETE" });
        loadMessages();
      } catch (err) {
        alert("Delete failed.");
        console.error(err);
      }
    }

    // Edit message UI + save
    function editMessage(id, oldText) {
      const msgDiv = document.querySelector(`div.message[data-id='${id}']`);
      if (!msgDiv) return;

      let input = msgDiv.querySelector("input.edit-input");
      if (input) return; // Already editing

      // Remove text paragraph
      const p = msgDiv.querySelector("p");
      if (p) p.style.display = "none";

      input = document.createElement("input");
      input.type = "text";
      input.className = "edit-input";
      input.value = oldText || "";
      msgDiv.insertBefore(input, msgDiv.querySelector("button.edit-btn"));

      input.focus();

      input.onkeydown = async (e) => {
        if (e.key === "Enter") {
          const newText = input.value.trim();
          if (!newText) {
            alert("Message cannot be empty.");
            return;
          }
          try {
            await fetch(`${API_MESSAGES}?id=${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text: newText }),
            });
            input.remove();
            if (p) {
              p.textContent = newText;
              p.style.display = "";
            }
            loadMessages();
          } catch (err) {
            alert("Edit failed.");
            console.error(err);
          }
        }
        if (e.key === "Escape") {
          input.remove();
          if (p) p.style.display = "";
        }
      };
    }

    sendBtn.addEventListener("click", sendMessage);

    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    // Initial load and polling every 3 seconds
    loadMessages();
    setInterval(loadMessages, 3000);
  </script>

</body>
</html>
