<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AntiChat - Arena</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0; font-family: 'Roboto', sans-serif;
      background: #1c1c1c; color: #e5ddd5;
      display: flex; flex-direction: column; height: 100vh;
    }
    header {
      background: #075e54; padding: 10px 20px;
      font-weight: bold; font-size: 20px; color: #fff;
      display: flex; justify-content: space-between; align-items: center;
    }
    #userInfo {
      font-size: 14px; opacity: 0.8;
    }
    #messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      background: #262d31;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 7px;
      position: relative;
      word-wrap: break-word;
    }
    .message.own {
      background: #dcf8c6;
      color: #000;
      align-self: flex-end;
    }
    .message.other {
      background: #333;
      color: #e5ddd5;
      align-self: flex-start;
    }
    .message .meta {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .message .actions {
      position: absolute;
      top: 2px; right: 4px;
      display: flex; gap: 6px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .message:hover .actions {
      opacity: 1;
    }
    .message .actions button {
      background: transparent;
      border: none;
      color: #555;
      cursor: pointer;
      font-size: 14px;
    }
    footer {
      display: flex;
      padding: 10px;
      background: #2a2f32;
    }
    #messageInput {
      flex-grow: 1;
      padding: 10px;
      border-radius: 20px;
      border: none;
      font-size: 16px;
      outline: none;
    }
    #sendBtn, #uploadBtn {
      background: #128c7e;
      border: none;
      color: white;
      padding: 10px 15px;
      margin-left: 8px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #uploadInput {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div>AntiChat Arena</div>
    <div id="userInfo"></div>
  </header>

  <div id="messages"></div>

  <footer>
    <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off" />
    <button id="uploadBtn" title="Upload file">üìé</button>
    <input type="file" id="uploadInput" />
    <button id="sendBtn" title="Send message">‚û°Ô∏è</button>
  </footer>

  <script>
    const userName = localStorage.getItem('antichat_name') || 'Unknown';
    const userUsername = localStorage.getItem('antichat_username') || 'unknown';

    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadInput = document.getElementById('uploadInput');
    const userInfo = document.getElementById('userInfo');

    userInfo.textContent = `${userName} (@${userUsername})`;

    async function fetchMessages() {
      try {
        const res = await fetch('/api/messages');
        if (!res.ok) throw new Error('Failed to fetch messages');
        const messages = await res.json();
        renderMessages(messages);
      } catch (e) {
        console.error(e);
      }
    }

    function renderMessages(messages) {
      messagesDiv.innerHTML = '';
      messages.forEach(msg => {
        const msgEl = document.createElement('div');
        msgEl.classList.add('message');
        msgEl.classList.add(msg.username === userUsername ? 'own' : 'other');
        msgEl.dataset.id = msg.id;

        let content = `<div class="meta">${msg.name} (@${msg.username})</div>`;

        if (msg.fileUrl) {
          const fileLink = `<a href="${msg.fileUrl}" target="_blank" style="color:inherit; text-decoration: underline;">üìé ${msg.text || 'File'}</a>`;
          content += fileLink;
        } else {
          content += `<div class="text">${escapeHtml(msg.text)}</div>`;
        }

        msgEl.innerHTML = content;

        // Add actions if own message
        if (msg.username === userUsername) {
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'actions';

          const editBtn = document.createElement('button');
          editBtn.title = 'Edit message';
          editBtn.textContent = '‚úèÔ∏è';
          editBtn.onclick = () => editMessage(msg);

          const delBtn = document.createElement('button');
          delBtn.title = 'Delete message';
          delBtn.textContent = 'üóëÔ∏è';
          delBtn.onclick = () => deleteMessage(msg.id);

          actionsDiv.appendChild(editBtn);
          actionsDiv.appendChild(delBtn);
          msgEl.appendChild(actionsDiv);
        }

        messagesDiv.appendChild(msgEl);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function sendMessage(text, fileUrl = null) {
      if (!text && !fileUrl) return;
      try {
        const payload = {
          username: userUsername,
          name: userName,
          text,
          fileUrl
        };
        const res = await fetch('/api/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Failed to send message');
        messageInput.value = '';
        fetchMessages();
      } catch (e) {
        alert('Failed to send message');
        console.error(e);
      }
    }

    sendBtn.addEventListener('click', () => {
      sendMessage(messageInput.value.trim());
    });

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage(messageInput.value.trim());
      }
    });

    // File upload logic
    uploadBtn.addEventListener('click', () => uploadInput.click());

    uploadInput.addEventListener('change', async () => {
      if (!uploadInput.files.length) return;
      const file = uploadInput.files[0];

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        if (!res.ok) throw new Error('Upload failed');
        const data = await res.json();
        await sendMessage(file.name, data.fileUrl);
        uploadInput.value = '';
      } catch (e) {
        alert('Failed to upload file');
        console.error(e);
      }
    });

    // Edit message
    function editMessage(msg) {
      const newText = prompt('Edit your message:', msg.text);
      if (newText === null) return;
      if (newText.trim() === '') {
        alert('Message cannot be empty');
        return;
      }
      fetch(`/api/messages?id=${msg.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: newText.trim() })
      }).then(res => {
        if (!res.ok) throw new Error('Failed to edit message');
        fetchMessages();
      }).catch(e => {
        alert('Failed to edit message');
        console.error(e);
      });
    }

    // Delete message
    function deleteMessage(id) {
      if (!confirm('Are you sure you want to delete this message?')) return;
      fetch(`/api/messages?id=${id}`, {
        method: 'DELETE'
      }).then(res => {
        if (!res.ok) throw new Error('Failed to delete message');
        fetchMessages();
      }).catch(e => {
        alert('Failed to delete message');
        console.error(e);
      });
    }

    // Initial load and polling every 3 seconds
    fetchMessages();
    setInterval(fetchMessages, 3000);
  </script>
</body>
</html>
