<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat Lobby - AntifiedNull</title>
  <style>
    body {
      margin: 0;
      font-family: monospace;
      background: #0d0d0d;
      color: #00ffc8;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    #messages {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #333;
      padding: 10px;
      background: #111;
      margin-bottom: 10px;
    }
    .msg {
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #222;
    }
    .msg button {
      float: right;
      background: red;
      color: white;
      border: none;
      font-size: 10px;
      cursor: pointer;
    }
    #message-input {
      width: 80%;
      padding: 10px;
      border: 1px solid #00ffc8;
      background: #111;
      color: #00ffc8;
    }
    #send-button {
      padding: 10px;
      background: #00ffc8;
      border: none;
      color: #000;
      cursor: pointer;
    }
    .popup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    .popup-content {
      background: #111;
      padding: 20px;
      border: 2px solid #00ffc8;
      width: 300px;
    }
    input {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      background: #222;
      border: 1px solid #00ffc8;
      color: #00ffc8;
    }
    .tabs {
      display: flex;
      margin-bottom: 10px;
    }
    .tabs button {
      flex: 1;
      padding: 10px;
      border: none;
      background: #00ffc8;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    #logout-btn {
      background: red;
      color: white;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<div class="popup" id="auth-popup">
  <div class="popup-content">
    <div class="tabs">
      <button onclick="showTab('signup')">Sign Up</button>
      <button onclick="showTab('login')">Login</button>
    </div>

    <div id="signup-form">
      <input type="text" id="signup-name" placeholder="Name" />
      <input type="email" id="signup-email" placeholder="Email" />
      <input type="password" id="signup-pass" placeholder="Password" />
      <input type="password" id="signup-pass2" placeholder="Confirm Password" />
      <button onclick="signup(event)">Sign Up</button>
    </div>

    <div id="login-form" style="display:none;">
      <input type="email" id="login-email" placeholder="Email" />
      <input type="password" id="login-pass" placeholder="Password" />
      <button onclick="login(event)">Login</button>
    </div>
  </div>
</div>

<div class="container" style="display:none;">
  <button id="logout-btn" onclick="logout()">Logout</button>
  <h2>Welcome, <span id="display-name"></span></h2>
  <div id="messages"></div>
  <form onsubmit="sendMessage(event)">
    <input type="text" id="message-input" placeholder="Type message..." required />
    <button id="send-button">Send</button>
  </form>
</div>

<script>
let currentUser = null;
let currentToken = null;

function showTab(tab) {
  document.getElementById('signup-form').style.display = tab === 'signup' ? 'block' : 'none';
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
}

function saveSession(name, token) {
  localStorage.setItem('chatUser', JSON.stringify({ name, token }));
}

function loadSession() {
  const data = localStorage.getItem('chatUser');
  return data ? JSON.parse(data) : null;
}

function logout() {
  localStorage.removeItem('chatUser');
  location.reload();
}

function signup(e) {
  e.preventDefault();
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const pass = document.getElementById('signup-pass').value;
  const pass2 = document.getElementById('signup-pass2').value;
  if (!name || !email || pass !== pass2 || pass.length < 6) return alert('Check inputs.');

  fetch('/api/server/signup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, password: pass })
  }).then(res => res.json())
    .then(data => {
      if (data.success) {
        saveSession(data.name, data.token);
        startChat(data.name, data.token);
      } else alert(data.message);
    });
}

function login(e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-pass').value;

  fetch('/api/server/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password: pass })
  }).then(res => res.json())
    .then(data => {
      if (data.success) {
        saveSession(data.name, data.token);
        startChat(data.name, data.token);
      } else alert(data.message);
    });
}

function startChat(name, token) {
  currentUser = name;
  currentToken = token;
  document.getElementById('auth-popup').style.display = 'none';
  document.querySelector('.container').style.display = 'block';
  document.getElementById('display-name').innerText = name;
  loadMessages();
}

function sendMessage(e) {
  e.preventDefault();
  const text = document.getElementById('message-input').value.trim();
  if (!text) return;

  fetch('/api/server/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + currentToken
    },
    body: JSON.stringify({ text })
  }).then(() => {
    document.getElementById('message-input').value = '';
    loadMessages();
  });
}

function loadMessages() {
  fetch('/api/server/messages', {
    headers: { 'Authorization': 'Bearer ' + currentToken }
  })
  .then(res => res.json())
  .then(data => {
    const box = document.getElementById('messages');
    box.innerHTML = '';
    data.messages.forEach(msg => {
      const div = document.createElement('div');
      div.className = 'msg';
      div.innerHTML = `<b>${msg.user}</b>: ${msg.text}`;
      if (msg.user === currentUser && msg.text !== '[MESSAGE DELETED]') {
        const btn = document.createElement('button');
        btn.textContent = 'Delete';
        btn.onclick = () => deleteMessage(msg.id);
        div.appendChild(btn);
      }
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  });
}

function deleteMessage(id) {
  fetch('/api/server/messages/' + id, {
    method: 'DELETE',
    headers: { 'Authorization': 'Bearer ' + currentToken }
  }).then(() => loadMessages());
}

window.onload = () => {
  const session = loadSession();
  if (session && session.token) {
    fetch('/api/server/verify-token', {
      headers: { 'Authorization': 'Bearer ' + session.token }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        startChat(session.name, session.token);
      } else {
        logout();
      }
    });
  }
};
</script>
</body>
</html>
