<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chat Lobby - AntifiedNull</title>
  <style>
    body {
      margin: 0;
      font-family: 'Courier New', monospace;
      background: #0e0e0e;
      color: #00ffcc;
    }
    .chat-container {
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    #messages {
      border: 1px solid #222;
      padding: 10px;
      height: 400px;
      overflow-y: scroll;
      background: #111;
      margin-bottom: 10px;
    }
    .msg {
      padding: 4px;
      margin: 4px 0;
      border-bottom: 1px solid #222;
    }
    .msg button {
      font-size: 10px;
      background: #ff0044;
      color: white;
      border: none;
      float: right;
      cursor: pointer;
    }
    #chat-form {
      display: flex;
    }
    #message-input {
      flex: 1;
      padding: 10px;
      background: #111;
      color: #00ffcc;
      border: 1px solid #00ffcc;
    }
    #send-button {
      background: #00ffcc;
      color: black;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
    }
    /* Popup */
    .popup {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .popup-content {
      background: #111;
      padding: 30px;
      border: 2px solid #00ffcc;
      width: 300px;
      text-align: center;
    }
    input {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      background: #222;
      border: 1px solid #00ffcc;
      color: #00ffcc;
    }
    .tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 10px;
    }
    .tabs button {
      flex: 1;
      background: #00ffcc;
      border: none;
      padding: 10px;
      cursor: pointer;
      color: black;
      font-weight: bold;
    }
    #logout-btn {
      margin-bottom: 20px;
      background: #ff0044;
      border: none;
      color: white;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 6px;
    }
  </style>
</head>
<body>
<div class="popup" id="auth-popup" style="display:none;">
  <div class="popup-content">
    <div class="tabs">
      <button onclick="showTab('signup')">Sign Up</button>
      <button onclick="showTab('login')">Login</button>
    </div>

    <div id="signup-form">
      <input type="text" id="signup-name" placeholder="Name" />
      <input type="email" id="signup-email" placeholder="Email" />
      <input type="password" id="signup-pass" placeholder="Password (8+ chars)" />
      <input type="password" id="signup-pass2" placeholder="Confirm Password" />
      <button onclick="signup()">Sign Up</button>
    </div>

    <div id="login-form" style="display:none;">
      <input type="email" id="login-email" placeholder="Email" />
      <input type="password" id="login-pass" placeholder="Password" />
      <button onclick="login()">Login</button>
    </div>
  </div>
</div>

<div class="chat-container" style="display:none;">
  <button id="logout-btn" onclick="logout()">Logout</button>
  <h2>Welcome to the Lobby, <span id="display-name"></span></h2>
  <div id="messages"></div>
  <form id="chat-form" onsubmit="sendMessage(event)">
    <input id="message-input" placeholder="Type your message..." required autocomplete="off" />
    <button id="send-button">Send</button>
  </form>
</div>

<script>
let currentUser = null;
let currentToken = null;

function showTab(tab) {
  document.getElementById('signup-form').style.display = tab === 'signup' ? 'block' : 'none';
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
}

function saveLogin(name, token) {
  localStorage.setItem('chatUser', JSON.stringify({ name, token }));
}

function loadLogin() {
  const data = localStorage.getItem('chatUser');
  if (!data) return null;
  try {
    return JSON.parse(data);
  } catch {
    return null;
  }
}

function clearLogin() {
  localStorage.removeItem('chatUser');
}

// Signup
function signup() {
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const pass = document.getElementById('signup-pass').value;
  const pass2 = document.getElementById('signup-pass2').value;

  if (pass.length < 8 || pass !== pass2) {
    alert("Password must be 8+ characters and match.");
    return;
  }
  if (!name || !email) {
    alert("Name and Email are required.");
    return;
  }

  fetch('/signup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, password: pass }),
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      currentUser = data.name;
      currentToken = data.token;
      saveLogin(currentUser, currentToken);
      hideAuthShowChat();
    } else {
      alert(data.message);
    }
  });
}

// Login
function login() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-pass').value;

  if (!email || !pass) {
    alert("Email and Password required.");
    return;
  }

  fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password: pass }),
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      currentUser = data.name;
      currentToken = data.token;
      saveLogin(currentUser, currentToken);
      hideAuthShowChat();
    } else {
      alert(data.message);
    }
  });
}

function logout() {
  currentUser = null;
  currentToken = null;
  clearLogin();
  document.querySelector('.chat-container').style.display = 'none';
  document.getElementById('auth-popup').style.display = 'flex';
}

// Load all messages from server and display them
function loadMessages() {
  fetch('/messages', {
    headers: {
      'Authorization': 'Bearer ' + currentToken
    }
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) {
      alert('Session expired or unauthorized. Please login again.');
      logout();
      return;
    }
    const messagesDiv = document.getElementById('messages');
    messagesDiv.innerHTML = '';
    data.messages.forEach(msg => {
      const msgElem = document.createElement('div');
      msgElem.classList.add('msg');
      msgElem.innerHTML = `<strong>${escapeHtml(msg.user)}:</strong> <span>${escapeHtml(msg.text)}</span>`;
      // Show delete button if this user sent the message
      if (msg.user === currentUser && msg.text !== '[MESSAGE DELETED]') {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.style.marginLeft = '10px';
        delBtn.onclick = () => deleteMessage(msg.id);
        msgElem.appendChild(delBtn);
      }
      messagesDiv.appendChild(msgElem);
    });
    // Scroll to bottom to see latest message
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  })
  .catch(() => {
    alert('Failed to load messages.');
  });
}

// Send new message to server
function sendMessage(e) {
  e.preventDefault();
  const input = document.getElementById('message-input');
  const text = input.value.trim();
  if (!text) return;

  fetch('/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + currentToken
    },
    body: JSON.stringify({ text })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) {
      alert('Failed to send message. Please login again.');
      logout();
      return;
    }
    input.value = '';
    loadMessages();
  })
  .catch(() => {
    alert('Failed to send message.');
  });
}

// Delete a message by id (only owner can delete)
function deleteMessage(id) {
  if (!confirm('Are you sure you want to delete this message?')) return;
  fetch('/messages/' + id, {
    method: 'DELETE',
    headers: {
      'Authorization': 'Bearer ' + currentToken
    }
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) {
      alert('Failed to delete message.');
      return;
    }
    loadMessages();
  })
  .catch(() => {
    alert('Failed to delete message.');
  });
}

// Show the chat UI and hide login/signup popup
function hideAuthShowChat() {
  document.getElementById('auth-popup').style.display = 'none';
  document.querySelector('.chat-container').style.display = 'block';
  document.getElementById('display-name').textContent = currentUser;
  loadMessages();
}

// Escape HTML special characters to prevent injection
function escapeHtml(text) {
  return text.replace(/[&<>"']/g, function(m) {
    return {'&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'}[m];
  });
}

// Save login info to localStorage
function saveLogin(name, token) {
  localStorage.setItem('chatUser', JSON.stringify({ name, token }));
}

// Load login info from localStorage
function loadLogin() {
  const val = localStorage.getItem('chatUser');
  if (!val) return null;
  try {
    return JSON.parse(val);
  } catch {
    return null;
  }
}

// Clear login info from localStorage and reload page
function logout() {
  currentUser = null;
  currentToken = null;
  localStorage.removeItem('chatUser');
  window.location.reload();
}

// Signup form handler
function signup(e) {
  e.preventDefault();
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value;

  if (!name || !email || !password) {
    alert('Please fill in all signup fields.');
    return;
  }

  fetch('/signup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, password })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) {
      alert('Signup failed: ' + data.message);
      return;
    }
    currentUser = data.name;
    currentToken = data.token;
    saveLogin(currentUser, currentToken);
    hideAuthShowChat();
  })
  .catch(() => {
    alert('Signup request failed.');
  });
}

// Login form handler
function login(e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;

  if (!email || !password) {
    alert('Please fill in all login fields.');
    return;
  }

  fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email, password })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) {
      alert('Login failed: ' + data.message);
      return;
    }
    currentUser = data.name;
    currentToken = data.token;
    saveLogin(currentUser, currentToken);
    hideAuthShowChat();
  })
  .catch(() => {
    alert('Login request failed.');
  });
}

// On page load, try to auto-login with stored token
window.onload = () => {
  const saved = loadLogin();
  if (saved && saved.name && saved.token) {
    currentUser = saved.name;
    currentToken = saved.token;
    fetch('/verify-token', {
      headers: { 'Authorization': 'Bearer ' + currentToken }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        hideAuthShowChat();
      } else {
        logout();
      }
    })
    .catch(() => {
      logout();
    });
  } else {
    document.getElementById('auth-popup').style.display = 'flex';
  }
};
</script>
</body>
</html>